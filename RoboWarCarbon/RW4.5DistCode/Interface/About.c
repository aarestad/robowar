/* About.c *//* Written 12/5/90 by David Harris 	This file contains code to do the about box.*//* #includes */#include <Carbon/Carbon.h>#include "robotypes.h"#define numPages 3/* External Variables */extern EventRecord	myEvent;#if __POWERPC__	extern	QDGlobals	qd;					/* To make PowerPC happy */#endif/* Globals */PicHandle			rob1;				/* Left side robot in about box */Rect				rRect1;				/* Left side robot box */PicHandle			rob2;				/* Right side robot in about box */Rect				rRect2;				/* Right side robot box */PicHandle			explosions[7];		/* 7 frames of robot 2's explosion */Rect				eRect[7];			/* 7 rectangles of explosion destinations */GWorldPtr			bullet1GW;			/* Bullet 1 Graphic World. */ //--- 19 apr 97 --- Rect				bRect1;				/* Left side bullet box */GWorldPtr			bullet2GW;			/* Bullet 2 Graphic World. */ //--- 19 apr 97 --- Rect				bRect2;				/* Right side bullet box */Rect				TextBox;			/* Rectangle with text */RgnHandle			tmpRgn;				/* A temporary region for scrollRect */short				aboutTime;			/* Parameter for robot movement */Handle				page[numPages];		/* Text of about box */// Handle				speech[numPages];	/* Text of about box (in format for speaking) */short				pageNum;			/* Current page being viewed */short				explosionState;		/* Frame in robot 2's explosion */Rect				userRect;			/* Rectangle of user item *//* Prototypes */void rectToRect(Rect *src,Rect *dest);short delta1(void);short delta2(void);void moveBullet1(void);void moveBullet2(void);void explodeRobot2(void);void updateProc(void);pascal void aboutBoxUserProc(WindowPtr window,short item);void loadPictures(void);void disposPictures(void);void aboutBox(void);/* in Speech.c */// void initSpeech(void);// void startSpeaking(Handle theText);// void endSpeaking(void);/* in Util.c */extern void checkMemErr(char *proc);extern void checkResErr(char *proc);extern void installButtonOutline(DialogPtr theDialog,short itemNo);extern void playSound(short whichSound,short whichBot);extern void reportMessage(char *message1,char *message2);/* Functions */void rectToRect(Rect *src,Rect *dest){	dest->top = src->top;	dest->bottom = src->bottom;	dest->left = src->left;	dest->right = src->right;}short delta1(void){	if (aboutTime < 120) return 1;	else if (aboutTime < 240) return -1;	else if (aboutTime < 280) return 2;	else if (aboutTime < 320) return 1;	else if (aboutTime < 440) return -1;	else if (aboutTime < 560) return 1;	else if (aboutTime < 600) return -2;	else if (aboutTime < 640) return -1;	else if (aboutTime < 760) return 1;	else if (aboutTime < 880) return -1;	else if ((aboutTime-880) % 240 < 120) return 1;	else return -1;}short delta2(void){	if (aboutTime < 120) return -1;	else if (aboutTime < 240) return 1;	else if (aboutTime < 360) return -1;	else if (aboutTime < 480) return 1;	else if (aboutTime < 600) return -1;	else if (aboutTime < 720) return 1;	else if (aboutTime < 769) return -1;	else return 0;}//--- 19 apr 97 --- Updated for GWorldsvoid moveBullet1(void){	if (bRect1.top) {		CopyBits(&((GrafPtr)bullet1GW)->portBits,&qd.thePort->portBits,&bullet1GW->portRect,&bRect1,srcXor,NULL); 		OffsetRect(&bRect1,5,0);		CopyBits(&((GrafPtr)bullet1GW)->portBits,&qd.thePort->portBits,&bullet1GW->portRect,&bRect1,srcXor,NULL); 		if (bRect1.left > qd.thePort->portRect.right) bRect1.top = 0;		else if (aboutTime == 769) {			bRect1.top = 0;			explosionState = 0;		}	}	else if (aboutTime == 88 || aboutTime == 221 || 			 aboutTime == 422 || aboutTime == 703) {		playSound(GunSndID,maxBots);		rectToRect(&bullet1GW->portRect,&bRect1);		OffsetRect(&bRect1,52,rRect1.top+23);		CopyBits(&((GrafPtr)bullet1GW)->portBits,&qd.thePort->portBits,&bullet1GW->portRect,&bRect1,srcXor,NULL); 	}}//--- 19 apr 97 --- Updated for GWorldsvoid moveBullet2(void){	if (bRect2.top) {		CopyBits(&((GrafPtr)bullet2GW)->portBits,&qd.thePort->portBits,&bullet2GW->portRect,&bRect2,srcXor,NULL);		if (bRect2.top > rRect1.bottom) OffsetRect(&bRect2,-2,-1);		else if (bRect2.bottom < rRect1.top) OffsetRect(&bRect2,-2,1);		else OffsetRect(&bRect2,-2,0);		CopyBits(&((GrafPtr)bullet2GW)->portBits,&qd.thePort->portBits,&bullet2GW->portRect,&bRect2,srcXor,NULL); 		if (bRect2.right < qd.thePort->portRect.left) bRect2.top = 0;	}	else if (aboutTime == 125 || aboutTime == 440) {		playSound(DroneSndID,maxBots);		rectToRect(&bullet2GW->portRect,&bRect2);		OffsetRect(&bRect2,379,rRect2.top+22);		CopyBits(&((GrafPtr)bullet2GW)->portBits,&qd.thePort->portBits,&bullet2GW->portRect,&bRect2,srcXor,NULL); 	}}void explodeRobot2(void){	static short count;	Rect r;		if (explosionState == 1)		playSound(ExplosionSndID,maxBots);	if (explosionState < 7) {		DrawPicture(explosions[explosionState],&eRect[explosionState]);		if (count) count = 0;		else {			count = 1;			explosionState++;		}	}	else if (explosionState == 7) {		r.top = 100; r.bottom = 250;		r.left = 379; r.right = 500;		EraseRect(&r);		explosionState++;	}}void updateProc(void){	short amount;		aboutTime++;	moveBullet1();	moveBullet2();	amount = delta1();	rRect1.bottom += 2;	rRect1.top -= 2;	ScrollRect(&rRect1,0,amount,tmpRgn); 	rRect1.bottom -= 2;	rRect1.top += 2;	OffsetRect(&rRect1,0,amount);	if (explosionState == -1) {		amount = delta2();		rRect2.bottom += 1;		rRect2.top -= 1;		ScrollRect(&rRect2,0,amount,tmpRgn); 		rRect2.bottom -= 1;		rRect2.top += 1;		OffsetRect(&rRect2,0,amount);	} else explodeRobot2();}//--- 19 apr 97 --- Updated for GWorldspascal void aboutBoxUserProc(WindowPtr window,short item){#pragma unused(window)#pragma unused(item)	EraseRect(&userRect);	DrawPicture(rob1,&rRect1);	if (explosionState == -1) 		DrawPicture (rob2,&rRect2);	else if (explosionState < 7)		DrawPicture(explosions[explosionState],&eRect[explosionState]);	TextFont(kFontIDGeneva);	TextSize(9);	ForeColor(blueColor);	HLock(page[pageNum]); 	TETextBox(*page[pageNum],GetHandleSize(page[pageNum]),&TextBox,teJustLeft);	HUnlock(page[pageNum]); 	ForeColor(blackColor);	TextFont(systemFont);	TextSize(12);	if (bRect1.top)		CopyBits(&((GrafPtr)bullet1GW)->portBits,&qd.thePort->portBits,&bullet1GW->portRect,&bRect1,srcXor,NULL); 	if (bRect2.top)		CopyBits(&((GrafPtr)bullet2GW)->portBits,&qd.thePort->portBits,&bullet2GW->portRect,&bRect2,srcXor,NULL); }//--- 19 apr 97 --- Updated for GWorldsvoid loadPictures(void){	CGrafPtr origPort;	GDHandle origDev;	QDErr	myErr;	Boolean	goodQ;	PixMapHandle offPixMapHandle;	PicHandle tmpPict;	short i;	rob1 = (PicHandle)GetResource('PICT',Rob1PictID);	checkResErr("About:loadPictures:1");	HNoPurge((Handle)rob1);	rectToRect(&(*rob1)->picFrame,&rRect1);	OffsetRect(&rRect1,0,82);	rob2 = (PicHandle)GetResource('PICT',Rob2PictID);	checkResErr("About:loadPictures:2");	HNoPurge((Handle)rob2);	rectToRect(&(*rob2)->picFrame,&rRect2);	OffsetRect(&rRect2,395,200);	GetGWorld(&origPort, &origDev);// create GWorlds for pictures of Bullets	tmpPict = GetPicture(Bullet1PictID);	checkResErr("About:loadPictures:1");	myErr = NewGWorld(&bullet1GW, 1, &(*tmpPict)->picFrame, nil, nil, 0);	if(bullet1GW == nil || myErr !=noErr)	{		checkMemErr("About:loadPictures:1");		reportMessage("There is a problem with graphics - Memory?", "About:loadPictures:1");		ExitToShell();	}	SetGWorld(bullet1GW, nil);	offPixMapHandle = GetGWorldPixMap(bullet1GW);	goodQ = LockPixels(offPixMapHandle);	if(!goodQ)	{		reportMessage("There is a problem with graphics - unknown", "About:loadPictures:2");		ExitToShell();	}	EraseRect(&bullet1GW->portRect);	DrawPicture(tmpPict,&bullet1GW->portRect);	UnlockPixels(offPixMapHandle);	ReleaseResource( (Handle)tmpPict );		tmpPict = GetPicture(Bullet2PictID);	checkResErr("About:loadPictures:3");	myErr = NewGWorld(&bullet2GW, 1, &(*tmpPict)->picFrame, nil, nil, 0);	if(bullet1GW == nil || myErr !=noErr)	{		checkMemErr("About:loadPictures:2");		reportMessage("There is a problem with graphics - Memory?", "About:loadPictures:3");		ExitToShell();	}	SetGWorld(bullet2GW, nil);	offPixMapHandle = GetGWorldPixMap(bullet2GW);	goodQ = LockPixels(offPixMapHandle);	if(!goodQ)	{		reportMessage("There is a problem with graphics - unknown", "About:loadPictures:4");		ExitToShell();	}	EraseRect(&bullet2GW->portRect);	DrawPicture(tmpPict,&bullet2GW->portRect);	UnlockPixels(offPixMapHandle);	ReleaseResource( (Handle)tmpPict );	SetGWorld(origPort, origDev);		for (i=0; i<numPages; i++) {		page[i] = GetResource('TEXT',1000+i);		checkResErr("About:loadPictures:4");		HNoPurge(page[i]);		// speech[i] = GetResource('TEXT',1100+i);		checkResErr("About:loadPictures:5");		// HNoPurge(speech[i]);	} 	TextBox.top = 82;	TextBox.bottom = 250;	TextBox.left = 60;	TextBox.right = 384;	for (i=0; i<7; i++) {		explosions[i] = (PicHandle)GetResource('PICT',1100+i);		checkResErr("About:loadPictures:6");		rectToRect(&(*explosions[i])->picFrame,&eRect[i]);		OffsetRect(&eRect[i],-eRect[i].left+379,-eRect[i].top+159);		HNoPurge((Handle)explosions[i]);	}		aboutTime = 0;	pageNum = 0;	explosionState = -1;	tmpRgn = NewRgn();	}//--- 19 apr 97 --- Updated for GWorldsvoid disposPictures(void){	short i;		HPurge((Handle)rob1);	HPurge((Handle)rob2);	checkMemErr("about:disposPictures");	DisposeRgn(tmpRgn);	for (i=0; i<numPages; i++) {		HPurge(page[i]);		// HPurge(speech[i]);	}	for (i=0; i<7; i++)		HPurge((Handle)explosions[i]);	DisposeGWorld(bullet1GW);	bullet1GW = NULL;	DisposeGWorld(bullet2GW);	bullet2GW = NULL;}void aboutBox(void){	DialogPtr aboutDialog;	short itemHit;	Handle item;	Rect r;	RgnHandle oldClip;	GrafPtr oldPort;	short eventHappened;	long time;	UserItemUPP userUPP;		oldClip = NewRgn();	GetClip(oldClip);		aboutDialog = GetNewDialog(AboutDlogID,NULL,(WindowPtr)-1);		/* Set user item */	ClipRect(&aboutDialog->portRect);	loadPictures();	// initSpeech();	installButtonOutline(aboutDialog,8);	GetDialogItem(aboutDialog,3,&itemHit,&item,&userRect);	userUPP = NewUserItemProc(&aboutBoxUserProc);	SetDialogItem(aboutDialog,3,itemHit,(Handle)userUPP,&userRect);	GetPort(&oldPort);	SetPort(aboutDialog);	itemHit = -1;	// startSpeaking(speech[pageNum]);	do {		time = TickCount()+2;		while (time > TickCount())			SystemTask();		updateProc();		eventHappened = GetNextEvent(everyEvent,&myEvent);		if (!IsDialogEvent(&myEvent)) {			if (myEvent.what == mouseDown) SysBeep(1);		}		else if (myEvent.what == keyDown && 				(myEvent.message & charCodeMask) == '\r') {					myEvent.what = 1;					myEvent.where.h = 256; /* A kludge to simulate a mouse down */					myEvent.where.v = 316;					DialogSelect(&myEvent,&aboutDialog,&itemHit);				}		else DialogSelect(&myEvent,&aboutDialog,&itemHit);		if (itemHit == 1 && pageNum < numPages-1) {			pageNum++;			if (pageNum == numPages-1) {				GetDialogItem(aboutDialog,1,&itemHit,&item,&r);				SetControlTitle((ControlHandle)item,"\pDone");			}			InvalRect(&qd.thePort->portRect);			itemHit = -1;			// endSpeaking();			// startSpeaking(speech[pageNum]);		}	} while (itemHit != 1);	// endSpeaking();	SetPort(oldPort);	DisposeDialog(aboutDialog);	DisposeRoutineDescriptor(userUPP);	disposPictures(); 	SetClip(oldClip);	DisposeRgn(oldClip);}