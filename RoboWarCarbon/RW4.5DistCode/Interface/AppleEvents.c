/* AppleEvents.c *//* Written 7/10/94 by David Harris *//* This file contains functions to support Apple Events under	System 7. */	/* Apple Events to support:	Sound on/off	Show battle on/off (& get)	Battle	Tournament Mode on / off	Remove all sounds	Close robot	Set robot #	numbots	Set max points	(worry about timeouts)*/	/* #includes */#include <Carbon/Carbon.h>#include "robotypes.h"/* Constants */#define errNoRobotSelected	1000#define errTooManyRobots	1001/* Apple Event Core Suite Info#define typeObjectSpecifier 'obj ' */ /* Globals */AEEventHandlerUPP handleOpenApplicationUPP;AEEventHandlerUPP handleDocumentsUPP;AEEventHandlerUPP handleQuitApplicationUPP;AEEventHandlerUPP handleSetParameterUPP;AEEventHandlerUPP handleGetParameterUPP;AEEventHandlerUPP handleCloseRobotUPP;AEEventHandlerUPP handleDuplicateRobotUPP;/* External Variables */extern 	short 			numBots;extern 	short 			botSelected;extern 	short			quitFlag;extern	short			isBattle;extern	short			isTournament;extern	robot			rob[maxBots];extern	short			mode;/* Prototypes */		void installAppleEventHandlers(void);OSErr pascal handleOpenApplication(AppleEvent *theAppleEvent,AppleEvent *reply,long refCon);OSErr pascal handleDocuments(AppleEvent *theAppleEvent,AppleEvent *reply,long printFlag);OSErr pascal handleQuitApplication(AppleEvent *theAppleEvent,AppleEvent *reply,long refCon);OSErr pascal handleSetParameter(AppleEvent *theAppleEvent,AppleEvent *reply,long refCon);OSErr pascal handleGetParameter(AppleEvent *theAppleEvent,AppleEvent *reply,long refCon);OSErr pascal handleCloseRobot(AppleEvent *theAppleEvent,AppleEvent *reply,long refCon);OSErr pascal handleDuplicateRobot(AppleEvent *theAppleEvent,AppleEvent *reply,long refCon);OSErr MyGotRequiredParams(AppleEvent *theAppleEvent);void installError(void);void highLevelEvent(EventRecord*);/* in File.c */extern void readRobot(void);extern void print(void);extern void closeRobot(void);extern void duplicateRobot(void);/* in Main.c*/extern void changeMode(short newMode);/* In Util.c */extern void reportMessage(char *message1,char *message2);extern OSErr checkFileErr(OSErr err,char *proc);/* Functions */void installAppleEventHandlers(void){	OSErr myErr;		handleOpenApplicationUPP = NewAEEventHandlerProc(&handleOpenApplication);	if (myErr = AEInstallEventHandler(kCoreEventClass,kAEOpenApplication,						handleOpenApplicationUPP,0,FALSE)) installError();	handleDocumentsUPP = NewAEEventHandlerProc(&handleDocuments);	if (myErr = AEInstallEventHandler(kCoreEventClass,kAEOpenDocuments,						handleDocumentsUPP,FALSE,FALSE)) installError();	if (myErr = AEInstallEventHandler(kCoreEventClass,kAEPrintDocuments,						handleDocumentsUPP,TRUE,FALSE)) installError();	handleQuitApplicationUPP = NewAEEventHandlerProc(&handleQuitApplication);	if (myErr = AEInstallEventHandler(kCoreEventClass,kAEQuitApplication,						handleQuitApplicationUPP,0,FALSE)) installError();	handleSetParameterUPP = NewAEEventHandlerProc(&handleSetParameter);	if (myErr = AEInstallEventHandler('core','setd',						handleSetParameterUPP,0,FALSE)) installError();	handleGetParameterUPP = NewAEEventHandlerProc(&handleGetParameter);	if (myErr = AEInstallEventHandler('core','getd',						handleGetParameterUPP,0,FALSE)) installError();	handleCloseRobotUPP = NewAEEventHandlerProc(&handleCloseRobot);	if (myErr = AEInstallEventHandler('core','clos',						handleCloseRobotUPP,0,FALSE)) installError();	handleDuplicateRobotUPP = NewAEEventHandlerProc(&handleDuplicateRobot);	if (myErr = AEInstallEventHandler('core','clon',						handleDuplicateRobotUPP,0,FALSE)) installError();			/* Useful events:		'core' 'save' Save		'core' 'dsiz' Data Size (tell RoboWar to get Data Size)		'core' 'cnte' Count (tell RoboWar to count)		'core' 'move'		'core' 'delo' Delete (tell RoboWar to delete word 3)		'core' 'crel'		'core' 'doex'				can't figure out:		'misc' 'cut '		'misc' 'copy'		'misc' 'past'	*/}OSErr pascal handleOpenApplication(AppleEvent *theAppleEvent,AppleEvent *reply,long refCon){#pragma unused (reply)#pragma unused (refCon)	OSErr myErr;		if ((myErr = MyGotRequiredParams(theAppleEvent)) != noErr) return myErr;	else {	}	return noErr;}OSErr pascal handleDocuments(AppleEvent *theAppleEvent,AppleEvent *reply,long printFlag){#pragma unused (reply)	OSErr myErr;	AEDescList docList;	long itemsInList,i,j;	FSSpec myFSS;	DescType returnedType;	AEKeyword keywd;	Size actualSize;	WDPBRec	wdpb;	FInfo info;		if (mode != arena) changeMode(arena_);	if (mode == arena) { /* Successfully changed modes */		if ((myErr = AEGetParamDesc(theAppleEvent,keyDirectObject,typeAEList,&docList)) != noErr)			reportMessage("Error getting parameters","in Open Document Apple Event");		if ((myErr = MyGotRequiredParams(theAppleEvent)) != noErr) return myErr;				myErr = AECountItems(&docList,&itemsInList);		for (i=1; (i<=itemsInList) && (numBots < maxBots); i++) {			myErr = AEGetNthPtr(&docList,i,typeFSS,&keywd,&returnedType,								&myFSS,sizeof(myFSS),&actualSize);			if (myErr == errAECoercionFail)				reportMessage ("Error coercing doc type","requested by Apple Event");			else if (myErr != noErr) 				reportMessage ("Error 'opening document'","requested by Apple Event");			else {				/* First check that file actually is a robot */				if (checkFileErr(FSpGetFInfo(&myFSS,&info),"AppleEvents:handleDocuments") == 					noErr && info.fdType == 'RobW') {					/* Open document */					/* Ugly hack to convert new FSSpec info back to old-style vRefNum */										wdpb.ioNamePtr = NULL;					wdpb.ioWDDirID = myFSS.parID;									wdpb.ioVRefNum = myFSS.vRefNum;					wdpb.ioWDProcID='RWAR';		/* Add indivual identification (seems bogus) */										if ((myErr = PBOpenWDSync( &wdpb )) != noErr) SysBeep(1);								rob[numBots].vRefNum = wdpb.ioVRefNum; /* Set to hacked vRefNum */					for (j=0; j<=myFSS.name[0]; j++)						rob[numBots].name[j] = myFSS.name[j];					readRobot();					if (printFlag) {						changeMode(draftingBoard_);						if (mode == draftingBoard) {							print();						}						changeMode(arena_);						if (mode != arena) SysBeep(1);					}				}			}		}		myErr = AEDisposeDesc(&docList);	}	return noErr;}OSErr pascal handleQuitApplication(AppleEvent *theAppleEvent,AppleEvent *reply,long refCon){#pragma unused (reply)#pragma unused (refCon)	OSErr myErr;		if ((myErr = MyGotRequiredParams(theAppleEvent)) != noErr) return myErr;	else {		quitFlag = 1;		isBattle = 0;		isTournament = 0;		return noErr;	}}OSErr pascal handleSetParameter(AppleEvent *theAppleEvent,AppleEvent *reply,long refCon){#pragma unused (reply)#pragma unused (refCon)	OSErr myErr;	char msg[80];	DescType actual;	Size actualSize;		/* Parse paramenters *//*	if ((myErr = AEGetParamDesc(theAppleEvent,keyDirectObject,'obj ',&desc)) != noErr)		reportMessage("Error getting parameters","in CloseRobot Apple Event"); */	myErr = AEGetParamPtr(theAppleEvent,keyDirectObject,'obj ',&actual,			(Ptr)msg,80,&actualSize);				/* This seems to have something to do with font	in		tell application "RoboWar" to set font to "helvetica"	*/			/*	else myErr = AEDisposeDesc(&desc);	if ((myErr = AEGetParamDesc(theAppleEvent,keyDirectObject,'keyw',&desc)) != noErr)		reportMessage("Error getting parameters","in CloseRobot Apple Event"); */	myErr = AEGetParamPtr(theAppleEvent,keyDirectObject,'keyw',&actual,			(Ptr)msg,80,&actualSize);/*	else myErr = AEDisposeDesc(&desc); */	/* And at least one more keyw item */		if ((myErr = MyGotRequiredParams(theAppleEvent)) != noErr) return myErr;	else {		}	return myErr;}OSErr pascal handleGetParameter(AppleEvent *theAppleEvent,AppleEvent *reply,long refCon){	#pragma unused (theAppleEvent)#pragma unused (reply)#pragma unused (refCon)	reportMessage ("received get event.","");	return noErr;}OSErr pascal handleCloseRobot(AppleEvent *theAppleEvent,AppleEvent *reply,long refCon){#pragma unused (reply)#pragma unused (refCon)	OSErr myErr;	AEDesc desc;		/* The close event appears to have a paramenter:			instruction												parameter AEDesc		tell application "RoboWar" to close						null		tell application "RoboWar" to close document			'type'		tell application "RoboWar" to close document "bozo"		'obj '		tell application "RoboWar" to close document {"bo","z"}	'obj '		tell application "RoboWar" to close document 3			'obj '	*/		/* Eat single bogus paramenter */	if ((myErr = AEGetParamDesc(theAppleEvent,keyDirectObject,typeObjectSpecifier,&desc)) != noErr)		reportMessage("Error getting parameters","in CloseRobot Apple Event");	else {		/* Extract the document from the object specifier */				myErr = AEDisposeDesc(&desc);	}	if ((myErr = MyGotRequiredParams(theAppleEvent)) != noErr) return myErr;	else {		if (botSelected != maxBots) closeRobot();		else return errNoRobotSelected;	}	return myErr;}OSErr pascal handleDuplicateRobot(AppleEvent *theAppleEvent,AppleEvent *reply,long refCon){#pragma unused (reply)#pragma unused (refCon)	OSErr myErr;	/* No parameters should be passed */	if ((myErr = MyGotRequiredParams(theAppleEvent)) != noErr) return myErr;	else {		if (numBots == maxBots) return errTooManyRobots;		else if (botSelected == maxBots) return errNoRobotSelected;		else duplicateRobot();	}	return myErr;}OSErr MyGotRequiredParams(AppleEvent *theAppleEvent){	/* Routine taken straight from Think Reference */		DescType	returnedType;	Size	actualSize;	OSErr	myErr;	myErr = AEGetAttributePtr(theAppleEvent, keyMissedKeywordAttr,					typeWildCard, &returnedType,					nil, 0, &actualSize);	if (myErr == errAEDescNotFound)	// you got all the required											//parameters		return	noErr;	else		if (myErr == noErr)  // you missed a required parameter			return	errAEParamMissed;		else	// the call to AEGetAttributePtr failed			return	myErr;}void installError(void){	reportMessage("Error installing Apple Event handler\n","");}void highLevelEvent(EventRecord *myEvent){	OSErr myErr;	//char errStr[80];		/* First, check if this is a special		application-defined high level event. */	/* None defined yet. */		/* Otherwise, assume the event is an AppleEvent */	myErr = AEProcessAppleEvent(myEvent);	if (myErr) {		switch (myErr) {			case errAECorruptData: reportMessage("Apple Event error","errAECorruptData"); break;			case errAENewerVersion: reportMessage("Apple Event error","errAENewerVersion"); break;			case errAENotAppleEvent: reportMessage("Apple Event error","errAENotAppleEvent"); break;			case errAEEventNotHandled: reportMessage("Apple Event error","errAEEventNotHandled"); break;			case errAEDescNotFound: reportMessage("Apple Event error","errAEDescNotFound"); break;			case errAEParamMissed: reportMessage("Apple Event error","errAEParamMissed"); break;			case errNoRobotSelected: reportMessage("Apple Event error","No Robot Selected"); break;			case errTooManyRobots: reportMessage("Apple Event error","Too Many Robots"); break;			default: reportMessage("Apple Event error","errAECorruptData"); break;		}	}}